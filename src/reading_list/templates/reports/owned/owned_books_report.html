<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>My GreatReads Library</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --kindle-color: #0066CC;
            --physical-color: #6B4BA3;
            --audio-color: #FF6600;
        }

        body {
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 10px;
            background: white;
        }

        .title-link {
            text-decoration: none;
            display: block;
        }

        .page-title {
            text-align: center;
            margin: 20px 0 30px 0;
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(
                to right,
                #0066CC,  /* Kindle blue */
                #6B4BA3,  /* Hardcover purple */
                #FF6600   /* Audio orange */
            );
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
            transition: opacity 0.2s ease;
        }

        .title-link:hover .page-title {
            opacity: 0.8;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .filter-container {
            position: sticky;
            top: 0;
            background-color: white;
            padding: 15px 0;
            z-index: 100;
            margin: 0 auto;
            width: 100%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .filter-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 100%;
            background: white;
            z-index: -1;
        }

        .filter-container::after {
            content: '';
            position: absolute;
            bottom: -20px;
            left: 0;
            right: 0;
            height: 20px;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 1), rgba(255, 255, 255, 0));
            pointer-events: none;
        }

        .filters {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
        }

        .filter-group {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .media-filters {
            display: flex;
            gap: 10px;
        }

        .filter-button {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            background-color: transparent;
            border: 2px solid;
        }

        /* Media-specific colors - Default state */
        .filter-button.kindle {
            color: #0066CC;
            border-color: #0066CC;
        }

        .filter-button.hardcover {
            color: #6B4BA3;
            border-color: #6B4BA3;
        }

        .filter-button.audio {
            color: #FF6600;
            border-color: #FF6600;
        }

        /* Active states - Filled background */
        .filter-button[data-active="true"].kindle {
            background-color: #0066CC;
            color: white;
            border-color: #0066CC;
        }

        .filter-button[data-active="true"].hardcover {
            background-color: #6B4BA3;
            color: white;
            border-color: #6B4BA3;
        }

        .filter-button[data-active="true"].audio {
            background-color: #FF6600;
            color: white;
            border-color: #FF6600;
        }

        /* Status filter styles - Read (Green) */
        .filter-button.status[data-status="read"] {
            color: #22c55e;
            border-color: #22c55e;
        }

        .filter-button[data-active="true"].status[data-status="read"] {
            background-color: #22c55e;
            color: white;
        }

        /* Status filter styles - Unread (Gray) */
        .filter-button.status[data-status="unread"] {
            color: #64748b;
            border-color: #64748b;
        }

        .filter-button[data-active="true"].status[data-status="unread"] {
            background-color: #64748b;
            color: white;
        }

        /* Hover effects */
        .filter-button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        /* Filter group layout */
        .filter-group {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .media-filters {
            display: flex;
            gap: 10px;
        }

        .stats-container {
            background: #ffffff;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .total-stats {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #edf2f7;
        }

        .stat-box {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2d3748;
        }

        .stat-label {
            font-size: 0.875rem;
            color: #718096;
            margin-top: 0.25rem;
        }

        .format-stats-table {
            width: 100%;
            border-spacing: 0 0.5rem;
        }

        .format-row {
            transition: transform 0.2s;
        }

        .format-row:hover {
            transform: translateX(4px);
        }

        .format-row td {
            padding: 0.75rem;
        }

        .format-name {
            font-weight: 500;
            padding-left: 1rem !important;
        }

        .format-stat {
            text-align: center;
        }

        /* Format-specific styling using the colors from media_stats.py */
        .format-row.physical {
            background: rgba(107, 75, 163, 0.1);  /* Space purple */
        }
        .format-row.physical .format-name {
            color: #6B4BA3;
        }

        .format-row.kindle {
            background: rgba(55, 160, 232, 0.1);  /* Kindle blue */
        }
        .format-row.kindle .format-name {
            color: #37A0E8;
        }

        .format-row.audio {
            background: rgba(246, 145, 30, 0.1);  /* Audible orange */
        }
        .format-row.audio .format-name {
            color: #F6911E;
        }

        .books-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        .book-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            position: relative !important; /* Force position relative */
        }

        .book-card:hover {
            transform: translateY(-5px);
        }

        .book-id-tooltip {
            visibility: hidden;
            position: absolute;
            top: 0;  /* Changed from -30px */
            left: 0; /* Changed from right: 10px */
            background-color: #000;  /* Solid black for testing */
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 9999;  /* Increased z-index */
            pointer-events: none;  /* Prevent tooltip from interfering with hover */
        }

        .book-card:hover .book-id-tooltip {
            visibility: visible;
        }

        .cover-container {
            position: relative;
            padding-top: 150%; /* 2:3 aspect ratio */
            width: 100%;
        }

        .cover-img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .book-info {
            padding: 15px;
        }

        .book-title {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
        }

        .book-author {
            margin: 5px 0;
            font-size: 0.9rem;
            color: #666;
        }

        .book-series {
            margin: 5px 0;
            font-size: 0.8rem;
            color: #888;
        }

        /* Format badges */
        .format-badges {
            position: absolute;
            bottom: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;  /* Changed to column for vertical stacking */
            gap: 5px;
            z-index: 2;
        }

        .format-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            color: white;
            text-transform: uppercase;
        }

        .format-badge.physical {
            background-color: #6B4BA3;  /* Space purple */
        }

        .format-badge.kindle {
            background-color: #0066CC;  /* Deeper Kindle blue */
        }

        .format-badge.audio {
            background-color: #FF6600;  /* Warmer Audible orange */
        }

        /* Reading status badge */
        .reading-status-badge {
            position: absolute;
            bottom: 10px;
            left: 10px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            text-transform: uppercase;
            z-index: 2;
            max-width: 40%;  /* Prevent overlap with format badges */
        }

        .reading-status-badge.read {
            background-color: #22c55e;
        }

        .reading-status-badge.unread {
            background-color: #64748b;
        }

        /* Filter buttons */
        .filters {
            padding: 20px 20px 0 20px;
        }

        .filter-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .filter-button {
            padding: 8px 16px;
            border-radius: 20px;
            border: 2px solid;
            background: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .filter-button:hover {
            opacity: 0.8;
        }

        .filter-button.status {
            border-color: #64748b;
            color: #64748b;
        }

        .filter-button.status.active {
            background-color: #64748b;
            color: white;
        }

        @media (max-width: 768px) {
            .books-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }

            .book-title {
                font-size: 0.9rem;
            }

            .book-author {
                font-size: 0.8rem;
            }

            .format-badge {
                font-size: 0.6rem;
                padding: 3px 6px;
            }

            .reading-status-badge {
                font-size: 0.7rem;
                padding: 3px 6px;
            }

            .format-badges {
                bottom: 10px;
                right: 5px;
            }

            .format-badge {
                font-size: 0.6rem;
                padding: 3px 6px;
            }

            .reading-status-badge {
                font-size: 0.7rem;
                padding: 3px 6px;
                left: 5px;
            }
        }
    </style>
</head>
<body>
    <a href="/" class="title-link">
        <h1 class="page-title">My GreatReads Library</h1>
    </a>

    <div class="filter-container">
        <div class="filters">
            <div class="filter-group">
                <button class="filter-button status" data-status="read">Read</button>
                <div class="media-filters">
                    <button class="filter-button media hardcover" data-format="physical">Physical</button>
                    <button class="filter-button media kindle" data-format="kindle">Kindle</button>
                    <button class="filter-button media audio" data-format="audio">Audio</button>
                </div>
                <button class="filter-button status" data-status="unread">Unread</button>
            </div>
        </div>
    </div>

    <div class="stats-container">
        <div class="total-stats">
            <div class="stat-box">
                <span class="stat-value">{{ total_books }}</span>
                <span class="stat-label">Books</span>
            </div>
            <div class="stat-box">
                <span class="stat-value">{{ total_read }}</span>
                <span class="stat-label">Read</span>
            </div>
            <div class="stat-box">
                <span class="stat-value">{{ total_books - total_read }}</span>
                <span class="stat-label">Unread</span>
            </div>
            <div class="stat-box">
                <span class="stat-value">{{ "%.1f"|format(total_read / total_books * 100 if total_books > 0 else 0) }}%</span>
                <span class="stat-label">Complete</span>
            </div>
        </div>

        <table class="format-stats-table">
            <tr class="format-row physical">
                <td class="format-name">Physical</td>
                <td class="format-stat">{{ format_stats.physical.total }}</td>
                <td class="format-stat">{{ format_stats.physical.read }}</td>
                <td class="format-stat">{{ format_stats.physical.total - format_stats.physical.read }}</td>
                <td class="format-stat">{{ "%.1f"|format(format_stats.physical.read / format_stats.physical.total * 100 if format_stats.physical.total > 0 else 0) }}%</td>
            </tr>
            <tr class="format-row kindle">
                <td class="format-name">Kindle</td>
                <td class="format-stat">{{ format_stats.kindle.total }}</td>
                <td class="format-stat">{{ format_stats.kindle.read }}</td>
                <td class="format-stat">{{ format_stats.kindle.total - format_stats.kindle.read }}</td>
                <td class="format-stat">{{ "%.1f"|format(format_stats.kindle.read / format_stats.kindle.total * 100 if format_stats.kindle.total > 0 else 0) }}%</td>
            </tr>
            <tr class="format-row audio">
                <td class="format-name">Audio</td>
                <td class="format-stat">{{ format_stats.audio.total }}</td>
                <td class="format-stat">{{ format_stats.audio.read }}</td>
                <td class="format-stat">{{ format_stats.audio.total - format_stats.audio.read }}</td>
                <td class="format-stat">{{ "%.1f"|format(format_stats.audio.read / format_stats.audio.total * 100 if format_stats.audio.total > 0 else 0) }}%</td>
            </tr>
        </table>
    </div>

    <div class="books-grid">
        {% for book in books %}
        <div class="book-card" 
             data-formats="{{ book.formats|map(attribute='type')|join(' ') }}"
             data-status="{{ 'read' if book.is_read else 'unread' }}">
            <div class="book-id-tooltip">{{ book.book_id }}</div>
            <div class="cover-container">
                <img class="cover-img" src="{{ book.cover_url }}" alt="{{ book.title }} cover">
                <div class="reading-status-badge {{ 'read' if book.is_read else 'unread' }}">
                    {{ 'Read' if book.is_read else 'Unread' }}
                </div>
                <div class="format-badges">
                    {% for format in book.formats %}
                        <span class="format-badge {{ format.type }}">{{ format.type|title }}</span>
                    {% endfor %}
                </div>
            </div>
            <div class="book-info">
                <h3 class="book-title">{{ book.title }}</h3>
                <p class="book-author">{{ book.author }}</p>
                {% if book.series %}
                <p class="book-series">{{ book.series }} #{{ "%.1f"|format(book.series_number) }}</p>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const statusFilters = document.querySelectorAll('.filter-button.status');
            const mediaFilters = document.querySelectorAll('.filter-button.media');
            const books = document.querySelectorAll('.book-card');

            function scrollToTop() {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            }

            // Add cache busting to book cover images
            function refreshBookCovers() {
                const timestamp = new Date().getTime();
                const coverImages = document.querySelectorAll('.book-cover img');
                coverImages.forEach(img => {
                    const currentSrc = img.src;
                    if (currentSrc.includes('?')) {
                        img.src = currentSrc.split('?')[0] + '?v=' + timestamp;
                    } else {
                        img.src = currentSrc + '?v=' + timestamp;
                    }
                });
            }

            // Refresh covers on page load
            refreshBookCovers();

            function updateVisibility() {
                const activeStatus = document.querySelector('.filter-button.status[data-active="true"]')?.dataset.status;
                const activeFormat = document.querySelector('.filter-button.media[data-active="true"]')?.dataset.format;

                books.forEach(book => {
                    const matchesStatus = !activeStatus || book.dataset.status === activeStatus;
                    const matchesFormat = !activeFormat || book.dataset.formats.includes(activeFormat);
                    book.style.display = (matchesStatus && matchesFormat) ? '' : 'none';
                });

                // Refresh covers after filtering
                refreshBookCovers();
            }

            statusFilters.forEach(btn => {
                btn.addEventListener('click', () => {
                    if (btn.dataset.active === "true") {
                        btn.dataset.active = "false";
                    } else {
                        statusFilters.forEach(b => b.dataset.active = "false");
                        btn.dataset.active = "true";
                    }
                    updateVisibility();
                    scrollToTop();
                });
            });

            mediaFilters.forEach(btn => {
                btn.addEventListener('click', () => {
                    if (btn.dataset.active === "true") {
                        btn.dataset.active = "false";
                    } else {
                        mediaFilters.forEach(b => b.dataset.active = "false");
                        btn.dataset.active = "true";
                    }
                    updateVisibility();
                    scrollToTop();
                });
            });

            // Add reload listener
            window.addEventListener('load', refreshBookCovers);
        });
    </script>
</body>
</html>